<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metabolic Guardian AI - ä»£è¬æ…¢ç—…æ™ºæ®ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body {
            font-size: 18px;
            background-color: #f0f2f5;
            color: #212529;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container {
            max-width: 900px;
        }
        .header-title {
            color: #0d6efd;
            font-weight: 800;
        }
        .nav-link {
            font-size: 1.1rem;
            font-weight: bold;
            color: #495057;
        }
        .nav-link.active {
            color: #0d6efd !important;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            overflow: hidden;
        }
        .card-header {
            font-weight: bold;
            padding: 15px 20px;
        }
        .btn-lg-custom {
            padding: 12px 20px;
            font-size: 1.1rem;
            border-radius: 10px;
        }
        .status-indicator {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .normal { color: #198754; }
        .warning { color: #fd7e14; }
        .danger { color: #dc3545; }
        .form-label {
            font-weight: bold;
        }
        .record-table th, .record-table td {
            font-size: 18px;
            vertical-align: middle;
        }
        textarea {
            font-size: 16px;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .action-buttons .btn {
            flex: 1;
        }
        .fhir-report {
            background-color: #f8f9fa;
            border-left: 5px solid #0d6efd;
            padding: 15px;
            margin-top: 15px;
            text-align: left;
            font-family: monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
        }
        .text-report {
            background-color: #f8f9fa;
            border-left: 5px solid #28a745;
            padding: 15px;
            margin-top: 15px;
            text-align: left;
            font-size: 1rem;
            line-height: 1.6;
            max-height: 300px;
            overflow-y: auto;
        }
        .email-tips {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            font-size: 16px;
        }
        /* é‡å° QR Code çš„æ¨£å¼ */
        #qrcode {
            display: flex;
            justify-content: center;
            margin: 20px auto;
            padding: 15px;
            background: white;
            border: 1px dashed #ccc;
            width: fit-content;
        }
        .medication-checkbox {
            transform: scale(1.0);
            margin-right: 10px;
        }
        .format-toggle {
            display: flex;
            justify-content: center;
            margin: 15px 0;
        }
        .format-toggle .btn {
            margin: 0 5px;
        }
        /* è—¥ç‰©å‹¾é¸å€åŸŸæ¨£å¼ */
        .medication-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }
        /* æ­·å²è¨˜éŒ„è¡¨æ ¼èª¿æ•´ */
        .record-table th:nth-child(1),
        .record-table td:nth-child(1) {
            width: 40px;
        }
        .record-table th:nth-child(2),
        .record-table td:nth-child(2) {
            width: 160px;
        }
        .record-table th:nth-child(3),
        .record-table td:nth-child(3) {
            width: 120px;
        }
        .record-table th:nth-child(4),
        .record-table td:nth-child(4) {
            width: 100px;
        }
        .record-table th:nth-child(5),
        .record-table td:nth-child(5) {
            width: 120px;
        }
        .record-table th:nth-child(6),
        .record-table td:nth-child(6) {
            width: 120px;
        }
        .history-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        .history-actions .btn {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <div class="text-center mb-4">
            <h1 class="header-title"><i class="fas fa-heartbeat me-2"></i>Metabolic Guardian AI</h1>
            <p class="text-muted">åŸºæ–¼ FHIR èˆ‡ AI çš„ä»£è¬æ…¢ç—…ã€Œæ™ºæ®ã€ç³»çµ±</p>
        </div>
        
        <ul class="nav nav-tabs nav-fill mb-4" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="bp-tab" data-bs-toggle="tab" data-bs-target="#bp-tab-pane" type="button"><i class="fas fa-heart me-2"></i>è¡€å£“ç›£æ¸¬</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="bs-tab" data-bs-toggle="tab" data-bs-target="#bs-tab-pane" type="button"><i class="fas fa-tint me-2"></i>è¡€ç³–ç›£æ¸¬</button>
            </li>
        </ul>
        
        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="bp-tab-pane">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <i class="fas fa-plus-circle me-2"></i>æ–°å¢è¡€å£“è¨˜éŒ„
                    </div>
                    <div class="card-body">
                        <form id="bp-form">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label">æ”¶ç¸®å£“ (mmHg)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control form-control-lg" id="bp-systolic" placeholder="ä¾‹å¦‚: 120" required>
                                        <button type="button" class="btn btn-outline-primary" onclick="simulateOCR('bp')">
                                            <i class="fas fa-camera me-1"></i> æ‹ç…§è­˜åˆ¥
                                        </button>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">èˆ’å¼µå£“ (mmHg)</label>
                                    <input type="number" class="form-control form-control-lg" id="bp-diastolic" placeholder="80" required>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">è„ˆæ (bpm)</label>
                                    <input type="number" class="form-control form-control-lg" id="bp-pulse" placeholder="72" required>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">æ¸¬é‡æ™‚é–“</label>
                                    <input type="datetime-local" class="form-control" id="bp-date" required>
                                </div>
                                <div class="col-12">
                                    <div class="medication-section">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input medication-checkbox" id="bp-medication">
                                            <label class="form-check-label fw-bold" for="bp-medication">ğŸ’Šæˆ‘ä»Šå¤©å·²æŒ‰æ™‚æœç”¨è¡€å£“è—¥</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12 mt-4">
                                    <button type="submit" class="btn btn-primary w-100 btn-lg-custom">ä¿å­˜è¨˜éŒ„</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                         <div class="card record-card" id="latest-bp-card" style="display: none;">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>æœ€æ–°è¡€å£“è¨˜éŒ„</h5>
                            </div>
                            <div class="card-body text-center">
                                <h2 class="display-4 fw-bold" id="latest-bp-value">135/85 mmHg</h2>
                                <div id="bp-status-badge" class="mb-3"></div>
                                <p class="text-muted">è„ˆæ: <span id="latest-bp-pulse" class="fw-bold">75</span> æ¬¡/åˆ†é˜</p>
                                <p class="text-muted">æ™‚é–“: <span id="latest-bp-time">2023-06-15 08:30</span></p>
                                <div class="action-buttons">
                                    <button class="btn btn-outline-danger" onclick="generateFHIR('bp')">
                                        <i class="fas fa-qrcode me-1"></i>ç”Ÿæˆæ€¥æ•‘è­·ç…§ (FHIR)
                                    </button>
                                    <button class="btn btn-outline-success" onclick="sendReport('bp')">
                                        <i class="fas fa-envelope me-1"></i>å›å‚³Gmail
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card record-card">
                            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-history me-2"></i>è¡€å£“æ­·å²è¨˜éŒ„</h5>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="select-all-bp">
                                    <label class="form-check-label text-white" for="select-all-bp">å…¨é¸</label>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table record-table mb-0">
                                        <thead>
                                            <tr class="text-center">
                                                <th></th>
                                                <th>æ™‚é–“</th>
                                                <th>è¡€å£“</th>
                                                <th>è„ˆæ</th>
                                                <th>ç‹€æ…‹</th>
                                                <th>æœè—¥</th>
                                            </tr>
                                        </thead>
                                        <tbody id="bp-history" class="text-center">
                                            <!-- è¡€å£“è¨˜éŒ„å°‡åœ¨é€™é‡Œå‹•æ…‹æ·»åŠ  -->
                                        </tbody>
                                    </table>
                                </div>
                                <div class="history-actions p-3">
                                    <button class="btn btn-outline-danger" onclick="generateFHIRFromHistory('bp')">
                                        <i class="fas fa-qrcode me-1"></i>ç”ŸæˆFHIR
                                    </button>
                                    <button class="btn btn-outline-success" onclick="sendReportFromHistory('bp')">
                                        <i class="fas fa-envelope me-1"></i>å›å‚³Gmail
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-pane fade" id="bs-tab-pane">
                 <div class="card">
                    <div class="card-header bg-primary text-white">
                        <i class="fas fa-tint me-2"></i>æ–°å¢è¡€ç³–è¨˜éŒ„
                    </div>
                    <div class="card-body">
                        <form id="bs-form">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label">è¡€ç³–å€¼ (mg/dL)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control form-control-lg" id="bs-value" required>
                                        <button type="button" class="btn btn-outline-primary" onclick="simulateOCR('bs')">
                                            <i class="fas fa-camera me-1"></i> æ‹ç…§è­˜åˆ¥
                                        </button>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">æ¸¬é‡æ™‚æ©Ÿ</label>
                                    <select class="form-select form-select-lg" id="bs-measurement-time" required>
                                        <option value="fasting">ç©ºè…¹ (Fasting)</option>
                                        <option value="post-prandial">é£¯å¾Œ (Post-prandial)</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">æ¸¬é‡æ™‚é–“</label>
                                    <input type="datetime-local" class="form-control" id="bs-date" required>
                                </div>
                                <div class="col-12">
                                    <div class="medication-section">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input medication-checkbox" id="bs-medication">
                                            <label class="form-check-label fw-bold" for="bs-medication">ğŸ’Šæˆ‘å·²æ–½æ‰“èƒ°å³¶ç´ /æœè—¥</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12 mt-4">
                                    <button type="submit" class="btn btn-primary w-100 btn-lg-custom">ä¿å­˜è¨˜éŒ„</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card record-card" id="latest-bs-card" style="display: none;">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>æœ€æ–°è¡€ç³–è¨˜éŒ„</h5>
                            </div>
                            <div class="card-body text-center">
                                <h2 class="display-4 fw-bold" id="latest-bs-value">--</h2>
                                <div id="bs-status-badge" class="mb-3"></div>
                                <p class="text-muted">æ¸¬é‡æ™‚æ©Ÿ: <span id="latest-bs-time-type" class="fw-bold">--</span></p>
                                <p class="text-muted">æ™‚é–“: <span id="latest-bs-time">--</span></p>
                                <div class="action-buttons">
                                    <button class="btn btn-outline-danger" onclick="generateFHIR('bs')">
                                        <i class="fas fa-qrcode me-1"></i>ç”Ÿæˆæ€¥æ•‘è­·ç…§ (FHIR)
                                    </button>
                                    <button class="btn btn-outline-success" onclick="sendReport('bs')">
                                        <i class="fas fa-envelope me-1"></i>å›å‚³Gmail
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card record-card">
                            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-history me-2"></i>è¡€ç³–æ­·å²è¨˜éŒ„</h5>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="select-all-bs">
                                    <label class="form-check-label text-white" for="select-all-bs">å…¨é¸</label>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table record-table mb-0">
                                        <thead>
                                            <tr class="text-center">
                                                <th></th>
                                                <th>æ™‚é–“</th>
                                                <th>è¡€ç³–å€¼</th>
                                                <th>æ™‚æ©Ÿ</th>
                                                <th>ç‹€æ…‹</th>
                                                <th>æœè—¥</th>
                                            </tr>
                                        </thead>
                                        <tbody id="bs-history" class="text-center">
                                            <!-- è¡€ç³–è¨˜éŒ„å°‡åœ¨é€™é‡Œå‹•æ…‹æ·»åŠ  -->
                                        </tbody>
                                    </table>
                                </div>
                                <div class="history-actions p-3">
                                    <button class="btn btn-outline-danger" onclick="generateFHIRFromHistory('bs')">
                                        <i class="fas fa-qrcode me-1"></i>ç”ŸæˆFHIR
                                    </button>
                                    <button class="btn btn-outline-success" onclick="sendReportFromHistory('bs')">
                                        <i class="fas fa-envelope me-1"></i>å›å‚³Gmail
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // åˆå§‹åŒ–è¡€å£“å’Œè¡€ç³–è¨˜éŒ„æ•¸çµ„
        let bpRecords = [];
        let bsRecords = [];
        
        // é é¢åŠ è¼‰æ™‚å¾localStorageè®€å–æ•¸æ“š
        document.addEventListener('DOMContentLoaded', function() {
            loadRecords();
            updateHistoryTables();
            updateLatestRecords();
            
            // è¨­ç½®è¡¨å–®æäº¤äº‹ä»¶
            document.getElementById('bp-form').addEventListener('submit', saveBpRecord);
            document.getElementById('bs-form').addEventListener('submit', saveBsRecord);
            
            // è¨­ç½®ç•¶å‰æ—¥æœŸæ™‚é–“ç‚ºé»˜èªå€¼
            const now = new Date();
            const formattedDateTime = now.toISOString().slice(0, 16);
            document.getElementById('bp-date').value = formattedDateTime;
            document.getElementById('bs-date').value = formattedDateTime;
            
            // è¨­ç½®å…¨é¸åŠŸèƒ½
            document.getElementById('select-all-bp').addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('#bp-history input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
            });
            
            document.getElementById('select-all-bs').addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('#bs-history input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
            });
        });
        
        // å¾localStorageåŠ è¼‰è¨˜éŒ„
        function loadRecords() {
            const savedBpRecords = localStorage.getItem('bpRecords');
            const savedBsRecords = localStorage.getItem('bsRecords');
            
            if (savedBpRecords) {
                bpRecords = JSON.parse(savedBpRecords);
            }
            
            if (savedBsRecords) {
                bsRecords = JSON.parse(savedBsRecords);
            }
        }
        
        // ä¿å­˜è¡€å£“è¨˜éŒ„
        function saveBpRecord(e) {
            e.preventDefault();
            
            const systolic = parseInt(document.getElementById('bp-systolic').value);
            const diastolic = parseInt(document.getElementById('bp-diastolic').value);
            const pulse = parseInt(document.getElementById('bp-pulse').value);
            const dateTime = document.getElementById('bp-date').value;
            const medicationTaken = document.getElementById('bp-medication').checked;
            
            // æª¢æŸ¥æ•¸å€¼æ˜¯å¦åˆç†
            if (systolic < 70 || systolic > 250 || diastolic < 40 || diastolic > 150) {
                Swal.fire({
                    icon: 'error',
                    title: 'æ•¸å€¼ç•°å¸¸',
                    text: 'è«‹è¼¸å…¥åˆç†çš„è¡€å£“æ•¸å€¼',
                    confirmButtonText: 'ç¢ºå®š'
                });
                return;
            }
            
            // æª¢æŸ¥è—¥ç‰©é—œè¯
            if ((systolic > 140 || diastolic > 90) && !medicationTaken) {
                Swal.fire({
                    icon: 'warning',
                    title: 'âš ï¸ ä»£è¬æ•¸å€¼è­¦ç¤ºï¼',
                    html: 'ç³»çµ±åµæ¸¬åˆ°æ‚¨çš„è¡€å£“æ•¸å€¼åé«˜ï¼Œä¸¦ä¸”æ‚¨å°šæœªå‹¾é¸æœè—¥ã€‚è«‹å…ˆç¢ºèªç”¨è—¥ç‹€æ³ï¼Œä¸¦ä¼‘æ¯10åˆ†é˜å¾Œå†æ¬¡æ¸¬é‡ã€‚<br><strong>[æ•¸æ“šæœªå„²å­˜]</strong>',
                    confirmButtonText: 'ç¢ºå®š'
                });
                return;
            }
            
            // å‰µå»ºæ–°è¨˜éŒ„
            const newRecord = {
                systolic: systolic,
                diastolic: diastolic,
                pulse: pulse,
                dateTime: dateTime,
                medicationTaken: medicationTaken,
                timestamp: new Date().getTime()
            };
            
            // æ·»åŠ åˆ°æ•¸çµ„ä¸¦ä¿å­˜
            bpRecords.unshift(newRecord);
            saveRecords();
            
            // æ›´æ–°UI
            updateHistoryTables();
            updateLatestRecords();
            
            // é‡ç½®è¡¨å–®
            document.getElementById('bp-form').reset();
            document.getElementById('bp-date').value = new Date().toISOString().slice(0, 16);
            
            // é¡¯ç¤ºæˆåŠŸæ¶ˆæ¯
            Swal.fire({
                icon: 'success',
                title: 'è¨˜éŒ„å·²ä¿å­˜',
                text: 'æ‚¨çš„è¡€å£“è¨˜éŒ„å·²æˆåŠŸä¿å­˜',
                confirmButtonText: 'ç¢ºå®š'
            });
        }
        
        // ä¿å­˜è¡€ç³–è¨˜éŒ„
        function saveBsRecord(e) {
            e.preventDefault();
            
            const value = parseInt(document.getElementById('bs-value').value);
            const measurementTime = document.getElementById('bs-measurement-time').value;
            const dateTime = document.getElementById('bs-date').value;
            const medicationTaken = document.getElementById('bs-medication').checked;
            
            // æª¢æŸ¥æ•¸å€¼æ˜¯å¦åˆç†
            if (value < 50 || value > 500) {
                Swal.fire({
                    icon: 'error',
                    title: 'æ•¸å€¼ç•°å¸¸',
                    text: 'è«‹è¼¸å…¥åˆç†çš„è¡€ç³–æ•¸å€¼',
                    confirmButtonText: 'ç¢ºå®š'
                });
                return;
            }
            
            // æª¢æŸ¥è—¥ç‰©é—œè¯
            if (value > 140 && !medicationTaken) {
                Swal.fire({
                    icon: 'warning',
                    title: 'âš ï¸ ä»£è¬æ•¸å€¼è­¦ç¤ºï¼',
                    html: 'ç³»çµ±åµæ¸¬åˆ°æ‚¨çš„è¡€ç³–æ•¸å€¼åé«˜ï¼Œä¸¦ä¸”æ‚¨å°šæœªå‹¾é¸æœè—¥ã€‚è«‹å…ˆç¢ºèªç”¨è—¥ç‹€æ³ï¼Œä¸¦ä¼‘æ¯10åˆ†é˜å¾Œå†æ¬¡æ¸¬é‡ã€‚<br><strong>[æ•¸æ“šæœªå„²å­˜]</strong>',
                    confirmButtonText: 'ç¢ºå®š'
                });
                return;
            }
            
            // å‰µå»ºæ–°è¨˜éŒ„
            const newRecord = {
                value: value,
                measurementTime: measurementTime,
                dateTime: dateTime,
                medicationTaken: medicationTaken,
                timestamp: new Date().getTime()
            };
            
            // æ·»åŠ åˆ°æ•¸çµ„ä¸¦ä¿å­˜
            bsRecords.unshift(newRecord);
            saveRecords();
            
            // æ›´æ–°UI
            updateHistoryTables();
            updateLatestRecords();
            
            // é‡ç½®è¡¨å–®
            document.getElementById('bs-form').reset();
            document.getElementById('bs-date').value = new Date().toISOString().slice(0, 16);
            
            // é¡¯ç¤ºæˆåŠŸæ¶ˆæ¯
            Swal.fire({
                icon: 'success',
                title: 'è¨˜éŒ„å·²ä¿å­˜',
                text: 'æ‚¨çš„è¡€ç³–è¨˜éŒ„å·²æˆåŠŸä¿å­˜',
                confirmButtonText: 'ç¢ºå®š'
            });
        }
        
        // ä¿å­˜è¨˜éŒ„åˆ°localStorage
        function saveRecords() {
            localStorage.setItem('bpRecords', JSON.stringify(bpRecords));
            localStorage.setItem('bsRecords', JSON.stringify(bsRecords));
        }
        
        // æ›´æ–°æ­·å²è¨˜éŒ„è¡¨æ ¼
        function updateHistoryTables() {
            // è¡€å£“æ­·å²è¨˜éŒ„
            const bpHistoryTable = document.getElementById('bp-history');
            bpHistoryTable.innerHTML = '';
            
            bpRecords.forEach((record, index) => {
                const row = document.createElement('tr');
                
                // æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“
                const formattedDateTime = formatDateTime(record.dateTime);
                
                // ç¢ºå®šç‹€æ…‹
                const status = getBpStatus(record.systolic, record.diastolic);
                
                row.innerHTML = `
                    <td><input type="checkbox" class="form-check-input" data-index="${index}"></td>
                    <td>${formattedDateTime}</td>
                    <td>${record.systolic}/${record.diastolic} mmHg</td>
                    <td>${record.pulse}</td>
                    <td><span class="status-indicator ${status.class}"><i class="${status.icon}"></i> ${status.text}</span></td>
                    <td>${record.medicationTaken ? 'æ˜¯' : 'å¦'}</td>
                `;
                
                bpHistoryTable.appendChild(row);
            });
            
            // è¡€ç³–æ­·å²è¨˜éŒ„
            const bsHistoryTable = document.getElementById('bs-history');
            bsHistoryTable.innerHTML = '';
            
            bsRecords.forEach((record, index) => {
                const row = document.createElement('tr');
                
                // æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“
                const formattedDateTime = formatDateTime(record.dateTime);
                
                // ç¢ºå®šç‹€æ…‹
                const status = getBsStatus(record.value, record.measurementTime);
                
                row.innerHTML = `
                    <td><input type="checkbox" class="form-check-input" data-index="${index}"></td>
                    <td>${formattedDateTime}</td>
                    <td>${record.value} mg/dL</td>
                    <td>${getMeasurementTimeText(record.measurementTime)}</td>
                    <td><span class="status-indicator ${status.class}"><i class="${status.icon}"></i> ${status.text}</span></td>
                    <td>${record.medicationTaken ? 'æ˜¯' : 'å¦'}</td>
                `;
                
                bsHistoryTable.appendChild(row);
            });
        }
        
        // æ›´æ–°æœ€æ–°è¨˜éŒ„å¡ç‰‡
        function updateLatestRecords() {
            // è¡€å£“æœ€æ–°è¨˜éŒ„
            if (bpRecords.length > 0) {
                const latestBp = bpRecords[0];
                const bpStatus = getBpStatus(latestBp.systolic, latestBp.diastolic);
                
                document.getElementById('latest-bp-value').textContent = `${latestBp.systolic}/${latestBp.diastolic} mmHg`;
                document.getElementById('latest-bp-pulse').textContent = latestBp.pulse;
                document.getElementById('latest-bp-time').textContent = formatDateTime(latestBp.dateTime);
                
                const statusElement = document.getElementById('bp-status-badge');
                statusElement.innerHTML = bpStatus.class === 'danger' 
                    ? '<span class="badge bg-danger">åé«˜ - æ³¨æ„</span>' 
                    : bpStatus.class === 'warning'
                    ? '<span class="badge bg-warning text-dark">éœ€æ³¨æ„</span>'
                    : '<span class="badge bg-success">æ•¸å€¼æ­£å¸¸</span>';
                
                document.getElementById('latest-bp-card').style.display = 'block';
            } else {
                document.getElementById('latest-bp-card').style.display = 'none';
            }
            
            // è¡€ç³–æœ€æ–°è¨˜éŒ„
            if (bsRecords.length > 0) {
                const latestBs = bsRecords[0];
                const bsStatus = getBsStatus(latestBs.value, latestBs.measurementTime);
                
                document.getElementById('latest-bs-value').textContent = `${latestBs.value} mg/dL`;
                document.getElementById('latest-bs-time-type').textContent = getMeasurementTimeText(latestBs.measurementTime);
                document.getElementById('latest-bs-time').textContent = formatDateTime(latestBs.dateTime);
                
                const statusElement = document.getElementById('bs-status-badge');
                statusElement.innerHTML = bsStatus.class === 'danger' 
                    ? '<span class="badge bg-danger">åé«˜ - æ³¨æ„</span>' 
                    : bsStatus.class === 'warning'
                    ? '<span class="badge bg-warning text-dark">éœ€æ³¨æ„</span>'
                    : '<span class="badge bg-success">æ•¸å€¼æ­£å¸¸</span>';
                
                document.getElementById('latest-bs-card').style.display = 'block';
            } else {
                document.getElementById('latest-bs-card').style.display = 'none';
            }
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“
        function formatDateTime(dateTimeString) {
            const date = new Date(dateTimeString);
            return date.toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            }).replace(/\//g, '-');
        }
        
        // ç²å–è¡€å£“ç‹€æ…‹
        function getBpStatus(systolic, diastolic) {
            if (systolic >= 140 || diastolic >= 90) {
                return { class: 'danger',  text: 'åé«˜' };
            } else if (systolic <= 90 || diastolic <= 60) {
                return { class: 'warning',  text: 'åä½' };
            } else {
                return { class: 'normal',  text: 'æ­£å¸¸' };
            }
        }
        
        // ç²å–è¡€ç³–ç‹€æ…‹
        function getBsStatus(value, measurementTime) {
            let upperLimit = 140; // é»˜èªä¸Šé™
            
            // æ ¹æ“šæ¸¬é‡æ™‚æ©Ÿèª¿æ•´ä¸Šé™
            if (measurementTime === 'post-prandial') {
                upperLimit = 180;
            }
            
            if (value < 70) {
                return { class: 'warning',  text: 'åä½' };
            } else if (value > upperLimit) {
                return { class: 'danger',text: 'åé«˜' };
            } else {
                return { class: 'normal', text: 'æ­£å¸¸' };
            }
        }
        
        // ç²å–æ¸¬é‡æ™‚æ©Ÿæ–‡æœ¬
        function getMeasurementTimeText(measurementTime) {
            switch (measurementTime) {
                case 'fasting': return 'ç©ºè…¹';
                case 'post-prandial': return 'é£¯å¾Œ';
                default: return measurementTime;
            }
        }
        
        // æ¨¡æ“¬OCRæ‹ç…§è­˜åˆ¥
        function simulateOCR(type) {
            Swal.fire({
                title: 'AIæ‹ç…§è­˜åˆ¥ä¸­...',
                html: 'æ­£åœ¨åˆ†ææ‚¨çš„æ¸¬é‡å„€å™¨ç…§ç‰‡',
                timer: 1500,
                timerProgressBar: true,
                didOpen: () => {
                    Swal.showLoading();
                }
            }).then(() => {
                // ç”Ÿæˆéš¨æ©Ÿä½†åˆç†çš„æ•¸å€¼
                if (type === 'bp') {
                    const systolic = Math.floor(Math.random() * 41) + 120; // 120-160
                    const diastolic = Math.floor(Math.random() * 26) + 70; // 70-95
                    const pulse = Math.floor(Math.random() * 31) + 60; // 60-90
                    
                    document.getElementById('bp-systolic').value = systolic;
                    document.getElementById('bp-diastolic').value = diastolic;
                    document.getElementById('bp-pulse').value = pulse;
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'è­˜åˆ¥æˆåŠŸ',
                        html: `å·²è­˜åˆ¥è¡€å£“å€¼: <strong>${systolic}/${diastolic} mmHg</strong><br>è„ˆæ: <strong>${pulse} æ¬¡/åˆ†é˜</strong>`,
                        confirmButtonText: 'ç¢ºå®š'
                    });
                } else if (type === 'bs') {
                    const value = Math.floor(Math.random() * 111) + 90; // 90-200
                    const measurementTimes = ['fasting', 'post-prandial'];
                    const measurementTime = measurementTimes[Math.floor(Math.random() * measurementTimes.length)];
                    
                    document.getElementById('bs-value').value = value;
                    document.getElementById('bs-measurement-time').value = measurementTime;
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'è­˜åˆ¥æˆåŠŸ',
                        html: `å·²è­˜åˆ¥è¡€ç³–å€¼: <strong>${value} mg/dL</strong><br>æ¸¬é‡æ™‚æ©Ÿ: <strong>${getMeasurementTimeText(measurementTime)}</strong>`,
                        confirmButtonText: 'ç¢ºå®š'
                    });
                }
            });
        }
        
        // æ¨¡æ“¬ FHIR ä¼ºæœå™¨ä¸Šå‚³
        function uploadFHIR(resource) {
            return new Promise(resolve => {
                setTimeout(() => resolve(true), 1000); // æ¨¡æ“¬ 1ç§’å»¶é²
            });
        }
        
        // å°‡FHIRè³‡æºè½‰æ›ç‚ºæ–‡å­—æ ¼å¼
        function fhirToText(resource, type) {
            let text = '';
            
            if (type === 'bp') {
                const latestBp = bpRecords[0];
                const bpStatus = getBpStatus(latestBp.systolic, latestBp.diastolic);
                
                text = `æ€¥è¨ºæ•‘å‘½è­·ç…§ (è¡€å£“) <br>

è³‡æºé¡å‹: Observation<br>
ç‹€æ…‹: æœ€çµ‚çµæœ<br>
LOINCä»£ç¢¼: 85354-9 (è¡€å£“é¢æ¿)<br>
æ‚£è€…: ç¤ºä¾‹æ‚£è€…<br>
æ¸¬é‡æ™‚é–“: ${formatDateTime(latestBp.dateTime)}<br>
æ¸¬é‡çµæœ<br>
æ”¶ç¸®å£“: ${latestBp.systolic} mmHg (LOINC: 8480-6)<br>
èˆ’å¼µå£“: ${latestBp.diastolic} mmHg (LOINC: 8462-4)<br>
è„ˆæ: ${latestBp.pulse} æ¬¡/åˆ†é˜ (LOINC: 8867-4)<br>
ç‹€æ…‹: ${bpStatus.text}<br>
æœè—¥æƒ…æ³: ${latestBp.medicationTaken ? 'å·²æŒ‰æ™‚æœè—¥' : 'æœªæŒ‰æ™‚æœè—¥'}`;
            } else if (type === 'bs') {
                const latestBs = bsRecords[0];
                const bsStatus = getBsStatus(latestBs.value, latestBs.measurementTime);
                
                text = `æ€¥è¨ºæ•‘å‘½è­·ç…§ (è¡€ç³–)<br>

è³‡æºé¡å‹: Observation<br>
ç‹€æ…‹: æœ€çµ‚çµæœ<br>
LOINCä»£ç¢¼: 41653-7 (æ¯›ç´°è¡€ç®¡è¡€ç³–)<br>
æ‚£è€…: ç¤ºä¾‹æ‚£è€…<br>
æ¸¬é‡æ™‚é–“: ${formatDateTime(latestBs.dateTime)}<br>
æ¸¬é‡æ™‚æ©Ÿ: ${getMeasurementTimeText(latestBs.measurementTime)}<br>
è¡€ç³–å€¼: ${latestBs.value} mg/dL<br>
ç‹€æ…‹: ${bsStatus.text}<br>
æœè—¥æƒ…æ³: ${latestBs.medicationTaken ? 'å·²æŒ‰æ™‚æœè—¥' : 'æœªæŒ‰æ™‚æœè—¥'}<br>`;
            }
            
            return text;
        }
        
        // ç”ŸæˆFHIRå ±å‘Š
        async function generateFHIR(type) {
            if (type === 'bp' && bpRecords.length === 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'ç„¡è¨˜éŒ„',
                    text: 'æ²’æœ‰å¯ç”¨çš„è¡€å£“è¨˜éŒ„',
                    confirmButtonText: 'ç¢ºå®š'
                });
                return;
            }
            
            if (type === 'bs' && bsRecords.length === 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'ç„¡è¨˜éŒ„',
                    text: 'æ²’æœ‰å¯ç”¨çš„è¡€ç³–è¨˜éŒ„',
                    confirmButtonText: 'ç¢ºå®š'
                });
                return;
            }
            
            let resource, title, desc;
            
            // é¡¯ç¤ºä¸Šå‚³ä¸­
            Swal.fire({
                title: 'æ­£åœ¨åŒæ­¥è‡³ FHIR Server',
                html: 'æ­£åœ¨åŠ å¯†ä¸¦ä¸Šå‚³æ•¸æ“š...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            if (type === 'bp') {
                const latestBp = bpRecords[0];
                const bpStatus = getBpStatus(latestBp.systolic, latestBp.diastolic);
                
                resource = {
                    resourceType: "Observation",
                    id: "blood-pressure-" + latestBp.timestamp,
                    status: "final",
                    code: {
                        coding: [{
                            system: "http://loinc.org",
                            code: "85354-9",
                            display: "Blood pressure panel"
                        }],
                        text: "Blood pressure"
                    },
                    subject: {
                        reference: "Patient/example",
                        display: "ç¤ºä¾‹æ‚£è€…"
                    },
                    effectiveDateTime: latestBp.dateTime,
                    component: [
                        {
                            code: {
                                coding: [{
                                    system: "http://loinc.org",
                                    code: "8480-6",
                                    display: "Systolic blood pressure"
                                }],
                                text: "Systolic blood pressure"
                            },
                            valueQuantity: {
                                value: latestBp.systolic,
                                unit: "mmHg",
                                system: "http://unitsofmeasure.org",
                                code: "mm[Hg]"
                            }
                        },
                        {
                            code: {
                                coding: [{
                                    system: "http://loinc.org",
                                    code: "8462-4",
                                    display: "Diastolic blood pressure"
                                }],
                                text: "Diastolic blood pressure"
                            },
                            valueQuantity: {
                                value: latestBp.diastolic,
                                unit: "mmHg",
                                system: "http://unitsofmeasure.org",
                                code: "mm[Hg]"
                            }
                        },
                        // æ–°å¢ï¼šè„ˆæ (Heart Rate) Component
                        {
                            code: {
                                coding: [{
                                    system: "http://loinc.org",
                                    code: "8867-4",
                                    display: "Heart rate"
                                }],
                                text: "Heart rate"
                            },
                            valueQuantity: {
                                value: latestBp.pulse,
                                unit: "beats/min",
                                system: "http://unitsofmeasure.org",
                                code: "/min"
                            }
                        }
                    ]
                };
                
                title = "æ€¥è¨ºæ•‘å‘½è­·ç…§ (è¡€å£“)";
                desc = "å·²åŒ…å«æœ€è¿‘ä¸€æ¬¡è¡€å£“èˆ‡è„ˆææ•¸æ“š";
            } else if (type === 'bs') {
                const latestBs = bsRecords[0];
                const bsStatus = getBsStatus(latestBs.value, latestBs.measurementTime);
                
                resource = {
                    resourceType: "Observation",
                    id: "blood-glucose-" + latestBs.timestamp,
                    status: "final",
                    code: {
                        coding: [{
                            system: "http://loinc.org",
                            code: "41653-7",
                            display: "Glucose [Mass/volume] in Capillary blood"
                        }, {
                            system: "http://example.org/fhir/CodeSystem/measurement-time",
                            code: latestBs.measurementTime,
                            display: getMeasurementTimeText(latestBs.measurementTime)
                        }],
                        text: "Blood glucose"
                    },
                    subject: {
                        reference: "Patient/example",
                        display: "ç¤ºä¾‹æ‚£è€…"
                    },
                    effectiveDateTime: latestBs.dateTime,
                    valueQuantity: {
                        value: latestBs.value,
                        unit: "mg/dL",
                        system: "http://unitsofmeasure.org",
                        code: "mg/dL"
                    }
                };
                
                title = "æ€¥è¨ºæ•‘å‘½è­·ç…§ (è¡€ç³–)";
                desc = "å·²åŒ…å«æœ€è¿‘ä¸€æ¬¡è¡€ç³–ç›£æ¸¬æ•¸æ“š";
            }
            
            // ç­‰å¾…æ¨¡æ“¬ä¸Šå‚³
            await uploadFHIR(resource);

            // ç”Ÿæˆæ¨¡æ“¬çš„ FHIR Server URL
            const fhirUrl = `https://hapi.fhir.org/baseR4/Observation/${resource.id}`;
            const jsonStr = JSON.stringify(resource, null, 2);
            const textReport = fhirToText(resource, type);

            // é¡¯ç¤ºçµæœèˆ‡ QR Code
            Swal.fire({
                title: title,
                html: `
                    <p class="text-danger fw-bold">${desc}</p>
                    <div id="qrcode"></div>
                    <p class="small text-muted">é†«è­·äººå“¡è«‹æƒæä¸Šæ–¹ QR Code è®€å– FHIR æ•¸æ“š</p>
                    <div class="format-toggle">
                        <button class="btn btn-outline-primary" id="text-format-btn">æ–‡å­—é¡¯ç¤º</button>
                        <button class="btn btn-primary" id="fhir-format-btn">FHIR R4 æ ¼å¼</button>
                    </div>
                    <div id="report-content">
                        <div class="text-report" id="text-report">${textReport}</div>
                        <div class="fhir-report" id="fhir-report" style="display: none;"><pre>${jsonStr}</pre></div>
                    </div>
                `,
                width: 700,
                confirmButtonText: 'é—œé–‰è­·ç…§',
                didOpen: () => {
                    // ä½¿ç”¨ QRCode.js ç”ŸæˆäºŒç¶­ç¢¼
                    new QRCode(document.getElementById("qrcode"), {
                        text: fhirUrl,
                        width: 150,
                        height: 150,
                        colorDark : "#d63384", // ä½¿ç”¨é†’ç›®çš„é¡è‰²
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.H
                    });
                    
                    // æ·»åŠ æ ¼å¼åˆ‡æ¢äº‹ä»¶
                    document.getElementById('text-format-btn').addEventListener('click', function() {
                        document.getElementById('text-report').style.display = 'block';
                        document.getElementById('fhir-report').style.display = 'none';
                        this.classList.add('btn-primary');
                        this.classList.remove('btn-outline-primary');
                        document.getElementById('fhir-format-btn').classList.remove('btn-primary');
                        document.getElementById('fhir-format-btn').classList.add('btn-outline-primary');
                    });
                    
                    document.getElementById('fhir-format-btn').addEventListener('click', function() {
                        document.getElementById('text-report').style.display = 'none';
                        document.getElementById('fhir-report').style.display = 'block';
                        this.classList.add('btn-primary');
                        this.classList.remove('btn-outline-primary');
                        document.getElementById('text-format-btn').classList.remove('btn-primary');
                        document.getElementById('text-format-btn').classList.add('btn-outline-primary');
                    });
                }
            });
        }
        
        // å¾æ­·å²è¨˜éŒ„ç”ŸæˆFHIR
        async function generateFHIRFromHistory(type) {
            const records = type === 'bp' ? bpRecords : bsRecords;
            const selectedIndices = getSelectedIndices(type);
            
            if (selectedIndices.length === 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'æœªé¸æ“‡è¨˜éŒ„',
                    text: 'è«‹è‡³å°‘é¸æ“‡ä¸€æ¢è¨˜éŒ„',
                    confirmButtonText: 'ç¢ºå®š'
                });
                return;
            }
            
            // é¡¯ç¤ºä¸Šå‚³ä¸­
            Swal.fire({
                title: 'æ­£åœ¨åŒæ­¥è‡³ FHIR Server',
                html: 'æ­£åœ¨åŠ å¯†ä¸¦ä¸Šå‚³æ•¸æ“š...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });
            
            // ç‚ºæ¯æ¢é¸ä¸­çš„è¨˜éŒ„ç”ŸæˆFHIRè³‡æº
            const resources = selectedIndices.map(index => {
                const record = records[index];
                
                if (type === 'bp') {
                    return {
                        resourceType: "Observation",
                        id: "blood-pressure-" + record.timestamp,
                        status: "final",
                        code: {
                            coding: [{
                                system: "http://loinc.org",
                                code: "85354-9",
                                display: "Blood pressure panel"
                            }],
                            text: "Blood pressure"
                        },
                        subject: {
                            reference: "Patient/example",
                            display: "ç¤ºä¾‹æ‚£è€…"
                        },
                        effectiveDateTime: record.dateTime,
                        component: [
                            {
                                code: {
                                    coding: [{
                                        system: "http://loinc.org",
                                        code: "8480-6",
                                        display: "Systolic blood pressure"
                                    }],
                                    text: "Systolic blood pressure"
                                },
                                valueQuantity: {
                                    value: record.systolic,
                                    unit: "mmHg",
                                    system: "http://unitsofmeasure.org",
                                    code: "mm[Hg]"
                                }
                            },
                            {
                                code: {
                                    coding: [{
                                        system: "http://loinc.org",
                                        code: "8462-4",
                                        display: "Diastolic blood pressure"
                                    }],
                                    text: "Diastolic blood pressure"
                                },
                                valueQuantity: {
                                    value: record.diastolic,
                                    unit: "mmHg",
                                    system: "http://unitsofmeasure.org",
                                    code: "mm[Hg]"
                                }
                            },
                            {
                                code: {
                                    coding: [{
                                        system: "http://loinc.org",
                                        code: "8867-4",
                                        display: "Heart rate"
                                    }],
                                    text: "Heart rate"
                                },
                                valueQuantity: {
                                    value: record.pulse,
                                    unit: "beats/min",
                                    system: "http://unitsofmeasure.org",
                                    code: "/min"
                                }
                            }
                        ]
                    };
                } else if (type === 'bs') {
                    return {
                        resourceType: "Observation",
                        id: "blood-glucose-" + record.timestamp,
                        status: "final",
                        code: {
                            coding: [{
                                system: "http://loinc.org",
                                code: "41653-7",
                                display: "Glucose [Mass/volume] in Capillary blood"
                            }, {
                                system: "http://example.org/fhir/CodeSystem/measurement-time",
                                code: record.measurementTime,
                                display: getMeasurementTimeText(record.measurementTime)
                            }],
                            text: "Blood glucose"
                        },
                        subject: {
                            reference: "Patient/example",
                            display: "ç¤ºä¾‹æ‚£è€…"
                        },
                        effectiveDateTime: record.dateTime,
                        valueQuantity: {
                            value: record.value,
                            unit: "mg/dL",
                            system: "http://unitsofmeasure.org",
                            code: "mg/dL"
                        }
                    };
                }
            });
            
            // ç­‰å¾…æ¨¡æ“¬ä¸Šå‚³
            await uploadFHIR(resources);
            
            // ç”ŸæˆBundleè³‡æº
            const bundle = {
                resourceType: "Bundle",
                type: "collection",
                entry: resources.map(resource => ({
                    resource: resource
                }))
            };
            
            const jsonStr = JSON.stringify(bundle, null, 2);
            const textReport = generateHistoryTextReport(selectedIndices, type);
            
            // é¡¯ç¤ºçµæœ
            Swal.fire({
                title: type === 'bp' ? "è¡€å£“æ­·å²è¨˜éŒ„FHIRå ±å‘Š" : "è¡€ç³–æ­·å²è¨˜éŒ„FHIRå ±å‘Š",
                html: `
                    <p class="text-danger fw-bold">å·²åŒ…å«${selectedIndices.length}æ¢è¨˜éŒ„</p>
                    <div class="format-toggle">
                        <button class="btn btn-outline-primary" id="text-format-btn">æ–‡å­—é¡¯ç¤º</button>
                        <button class="btn btn-primary" id="fhir-format-btn">FHIR R4 æ ¼å¼</button>
                    </div>
                    <div id="report-content">
                        <div class="text-report" id="text-report">${textReport}</div>
                        <div class="fhir-report" id="fhir-report" style="display: none;"><pre>${jsonStr}</pre></div>
                    </div>
                `,
                width: 700,
                confirmButtonText: 'é—œé–‰',
                didOpen: () => {
                    // æ·»åŠ æ ¼å¼åˆ‡æ¢äº‹ä»¶
                    document.getElementById('text-format-btn').addEventListener('click', function() {
                        document.getElementById('text-report').style.display = 'block';
                        document.getElementById('fhir-report').style.display = 'none';
                        this.classList.add('btn-primary');
                        this.classList.remove('btn-outline-primary');
                        document.getElementById('fhir-format-btn').classList.remove('btn-primary');
                        document.getElementById('fhir-format-btn').classList.add('btn-outline-primary');
                    });
                    
                    document.getElementById('fhir-format-btn').addEventListener('click', function() {
                        document.getElementById('text-report').style.display = 'none';
                        document.getElementById('fhir-report').style.display = 'block';
                        this.classList.add('btn-primary');
                        this.classList.remove('btn-outline-primary');
                        document.getElementById('text-format-btn').classList.remove('btn-primary');
                        document.getElementById('text-format-btn').classList.add('btn-outline-primary');
                    });
                }
            });
        }
        
        // ç”Ÿæˆæ­·å²è¨˜éŒ„çš„æ–‡å­—å ±å‘Š
        function generateHistoryTextReport(selectedIndices, type) {
            const records = type === 'bp' ? bpRecords : bsRecords;
            let text = type === 'bp' ? "è¡€å£“æ­·å²è¨˜éŒ„å ±å‘Š\n\n<br>------------------------\n<br>" : "è¡€ç³–æ­·å²è¨˜éŒ„å ±å‘Š\n\n<br>------------------------\n<br>";
            
            selectedIndices.forEach(index => {
                const record = records[index];
                
                if (type === 'bp') {
                    const status = getBpStatus(record.systolic, record.diastolic);
                    text += `

æ¸¬é‡æ™‚é–“: ${formatDateTime(record.dateTime)}<br>
è¡€å£“å€¼: ${record.systolic}/${record.diastolic} mmHg<br>
è„ˆæ: ${record.pulse} æ¬¡/åˆ†é˜<br>
ç‹€æ…‹: ${status.text}<br>
æœè—¥æƒ…æ³: ${record.medicationTaken ? 'å·²æŒ‰æ™‚æœè—¥' : 'æœªæŒ‰æ™‚æœè—¥'}<br>
------------------------\n<br>`;
                } else if (type === 'bs') {
                    const status = getBsStatus(record.value, record.measurementTime);
                    text += `

æ¸¬é‡æ™‚é–“: ${formatDateTime(record.dateTime)}<br>
è¡€ç³–å€¼: ${record.value} mg/dL<br>
æ¸¬é‡æ™‚æ©Ÿ: ${getMeasurementTimeText(record.measurementTime)}<br>
ç‹€æ…‹: ${status.text}<br>
æœè—¥æƒ…æ³: ${record.medicationTaken ? 'å·²æŒ‰æ™‚æœè—¥' : 'æœªæŒ‰æ™‚æœè—¥'}<br>
------------------------\n<br>`;
                }
            });
            
            return text;
        }
        
        // ç²å–é¸ä¸­çš„è¨˜éŒ„ç´¢å¼•
        function getSelectedIndices(type) {
            const checkboxes = document.querySelectorAll(`#${type}-history input[type="checkbox"]:checked`);
            return Array.from(checkboxes).map(checkbox => parseInt(checkbox.getAttribute('data-index')));
        }
        
        // ç™¼é€å ±å‘Šåˆ°Gmailï¼ˆæ¨¡æ“¬ï¼‰
        function sendReport(type) {
            if (type === 'bp' && bpRecords.length === 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'ç„¡è¨˜éŒ„',
                    text: 'æ²’æœ‰å¯ç”¨çš„è¡€å£“è¨˜éŒ„',
                    confirmButtonText: 'ç¢ºå®š'
                });
                return;
            }
            
            if (type === 'bs' && bsRecords.length === 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'ç„¡è¨˜éŒ„',
                    text: 'æ²’æœ‰å¯ç”¨çš„è¡€ç³–è¨˜éŒ„',
                    confirmButtonText: 'ç¢ºå®š'
                });
                return;
            }
            
            // é¦–å…ˆè©¢å•ç”¨æˆ¶è¼¸å…¥Gmailåœ°å€
            Swal.fire({
                title: 'è«‹è¼¸å…¥æ‚¨çš„Gmailåœ°å€',
                input: 'email',
                inputLabel: 'æˆ‘å€‘å°‡æŠŠå ±å‘Šç™¼é€åˆ°æ­¤éƒµç®±',
                inputPlaceholder: 'example@gmail.com',
                showCancelButton: true,
                confirmButtonText: 'ç™¼é€',
                cancelButtonText: 'å–æ¶ˆ',
                inputValidator: (value) => {
                    if (!value) {
                        return 'è«‹è¼¸å…¥æœ‰æ•ˆçš„Gmailåœ°å€';
                    }
                    if (!value.includes('@gmail.com')) {
                        return 'è«‹è¼¸å…¥æœ‰æ•ˆçš„Gmailåœ°å€';
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const email = result.value;
                    
                    // æ¨¡æ“¬ç™¼é€éç¨‹
                    Swal.fire({
                        title: 'ç™¼é€ä¸­...',
                        html: 'æ­£åœ¨å°‡å ±å‘Šç™¼é€åˆ°æ‚¨çš„Gmailéƒµç®±',
                        timer: 2000,
                        timerProgressBar: true,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    }).then(() => {
                        let reportContent, title;
                        
                        if (type === 'bp') {
                            const latestBp = bpRecords[0];
                            const bpStatus = getBpStatus(latestBp.systolic, latestBp.diastolic);
                            
                            title = "è¡€å£“å ±å‘Š";
                            reportContent = `
æ‚£è€…å§“å: ç¤ºä¾‹æ‚£è€…
æ¸¬é‡æ™‚é–“: ${formatDateTime(latestBp.dateTime)}
è¡€å£“å€¼: ${latestBp.systolic}/${latestBp.diastolic} mmHg
è„ˆæ: ${latestBp.pulse} æ¬¡/åˆ†é˜
ç‹€æ…‹: ${bpStatus.text}
æœè—¥æƒ…æ³: ${latestBp.medicationTaken ? 'å·²æŒ‰æ™‚æœè—¥' : 'æœªæŒ‰æ™‚æœè—¥'}

=== FHIR R4 æ‘˜è¦ ===
è³‡æºé¡å‹: Observation
LOINCä»£ç¢¼: 85354-9 (Blood pressure panel)
æ”¶ç¸®å£“: ${latestBp.systolic} mmHg (LOINC: 8480-6)
èˆ’å¼µå£“: ${latestBp.diastolic} mmHg (LOINC: 8462-4)
æ¸¬é‡æ™‚é–“: ${latestBp.dateTime}
                            `;
                        } else if (type === 'bs') {
                            const latestBs = bsRecords[0];
                            const bsStatus = getBsStatus(latestBs.value, latestBs.measurementTime);
                            
                            title = "è¡€ç³–å ±å‘Š";
                            reportContent = `
æ‚£è€…å§“å: ç¤ºä¾‹æ‚£è€…
æ¸¬é‡æ™‚é–“: ${formatDateTime(latestBs.dateTime)}
è¡€ç³–å€¼: ${latestBs.value} mg/dL
æ¸¬é‡æ™‚æ©Ÿ: ${getMeasurementTimeText(latestBs.measurementTime)}
ç‹€æ…‹: ${bsStatus.text}
æœè—¥æƒ…æ³: ${latestBs.medicationTaken ? 'å·²æŒ‰æ™‚æœè—¥' : 'æœªæŒ‰æ™‚æœè—¥'}

=== FHIR R4 æ‘˜è¦ ===
è³‡æºé¡å‹: Observation
LOINCä»£ç¢¼: 41653-7 (Glucose [Mass/volume] in Capillary blood)
æ¸¬é‡æ™‚æ©Ÿ: ${getMeasurementTimeText(latestBs.measurementTime)}
è¡€ç³–å€¼: ${latestBs.value} mg/dL
æ¸¬é‡æ™‚é–“: ${latestBs.dateTime}
                            `;
                        }
                        
                        // é¡¯ç¤ºç™¼é€æˆåŠŸæ¶ˆæ¯
                        Swal.fire({
                            title: 'å ±å‘Šå·²ç™¼é€',
                            html: `
                                <p>å·²æˆåŠŸå°‡${title}ç™¼é€è‡³ <strong>${email}</strong></p>
                                <div class="email-tips">
                                    <p><strong>éƒµä»¶æŸ¥çœ‹æç¤ºï¼š</strong></p>
                                    <ul>
                                        <li>è«‹ä»¥ã€ŒHTMLæ–¹å¼ã€ç€è¦½éƒµä»¶ï¼Œä¸¦å…è¨±ã€Œé¡¯ç¤ºåœ–ç‰‡ã€ï¼Œæ‰å¯æ­£ç¢ºæŸ¥çœ‹å ±å‘Šå…§å®¹</li>
                                        <li>è‹¥æ²’æœ‰æ”¶åˆ°Emailï¼Œè«‹ç¢ºèªEmailä½å€æ˜¯å¦æœ‰éŒ¯ï¼Œæˆ–æ˜¯è¢«ç•¶å»£å‘Šä¿¡ä»¶éæ¿¾æ‰ï¼</li>
                                    </ul>
                                </div>
                                <textarea class="form-control mt-3" rows="10" readonly>${reportContent.trim()}</textarea>
                            `,
                            confirmButtonText: 'é—œé–‰',
                            width: '700px'
                        });
                    });
                }
            });
        }
        
        // å¾æ­·å²è¨˜éŒ„ç™¼é€å ±å‘Šåˆ°Gmail
        function sendReportFromHistory(type) {
            const selectedIndices = getSelectedIndices(type);
            
            if (selectedIndices.length === 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'æœªé¸æ“‡è¨˜éŒ„',
                    text: 'è«‹è‡³å°‘é¸æ“‡ä¸€æ¢è¨˜éŒ„',
                    confirmButtonText: 'ç¢ºå®š'
                });
                return;
            }
            
            // é¦–å…ˆè©¢å•ç”¨æˆ¶è¼¸å…¥Gmailåœ°å€
            Swal.fire({
                title: 'è«‹è¼¸å…¥æ‚¨çš„Gmailåœ°å€',
                input: 'email',
                inputLabel: 'æˆ‘å€‘å°‡æŠŠå ±å‘Šç™¼é€åˆ°æ­¤éƒµç®±',
                inputPlaceholder: 'example@gmail.com',
                showCancelButton: true,
                confirmButtonText: 'ç™¼é€',
                cancelButtonText: 'å–æ¶ˆ',
                inputValidator: (value) => {
                    if (!value) {
                        return 'è«‹è¼¸å…¥æœ‰æ•ˆçš„Gmailåœ°å€';
                    }
                    if (!value.includes('@gmail.com')) {
                        return 'è«‹è¼¸å…¥æœ‰æ•ˆçš„Gmailåœ°å€';
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const email = result.value;
                    
                    // æ¨¡æ“¬ç™¼é€éç¨‹
                    Swal.fire({
                        title: 'ç™¼é€ä¸­...',
                        html: 'æ­£åœ¨å°‡å ±å‘Šç™¼é€åˆ°æ‚¨çš„Gmailéƒµç®±',
                        timer: 2000,
                        timerProgressBar: true,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    }).then(() => {
                        const records = type === 'bp' ? bpRecords : bsRecords;
                        const title = type === 'bp' ? "è¡€å£“æ­·å²è¨˜éŒ„å ±å‘Š" : "è¡€ç³–æ­·å²è¨˜éŒ„å ±å‘Š";
                        const reportContent = generateHistoryTextReport(selectedIndices, type);
                        
                        // é¡¯ç¤ºç™¼é€æˆåŠŸæ¶ˆæ¯
                        Swal.fire({
                            title: 'å ±å‘Šå·²ç™¼é€',
                            html: `
                                <p>å·²æˆåŠŸå°‡${title}ç™¼é€è‡³ <strong>${email}</strong></p>
                                <div class="email-tips">
                                    <p><strong>éƒµä»¶æŸ¥çœ‹æç¤ºï¼š</strong></p>
                                    <ul>
                                        <li>è«‹ä»¥ã€ŒHTMLæ–¹å¼ã€ç€è¦½éƒµä»¶ï¼Œä¸¦å…è¨±ã€Œé¡¯ç¤ºåœ–ç‰‡ã€ï¼Œæ‰å¯æ­£ç¢ºæŸ¥çœ‹å ±å‘Šå…§å®¹</li>
                                        <li>è‹¥æ²’æœ‰æ”¶åˆ°Emailï¼Œè«‹ç¢ºèªEmailä½å€æ˜¯å¦æœ‰éŒ¯ï¼Œæˆ–æ˜¯è¢«ç•¶å»£å‘Šä¿¡ä»¶éæ¿¾æ‰ï¼</li>
                                    </ul>
                                </div>
                                <textarea class="form-control mt-3" rows="10" readonly>${reportContent}</textarea>
                            `,
                            confirmButtonText: 'é—œé–‰',
                            width: '700px'
                        });
                    });
                }
            });
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é†«å¸«æª¢è¦–å ±å‘Š (å³æ™‚åŒæ­¥ç‰ˆ) - Chronic Illness Guardian</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .report-header { background: white; border-bottom: 3px solid #0d6efd; padding: 20px 0; margin-bottom: 30px; }
        .patient-card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); height: 100%; }
        .metric-card { background: white; border-radius: 10px; padding: 15px; border-left: 5px solid; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .border-bp { border-left-color: #dc3545; }
        .border-bs { border-left-color: #ffc107; }
        .chart-container { height: 300px; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .print-btn { position: fixed; bottom: 20px; right: 20px; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .live-badge { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        #status-indicator { position: fixed; top: 10px; right: 10px; z-index: 1050; }
    </style>
</head>
<body>

    <div id="status-indicator" class="badge bg-secondary">é€£ç·šä¸­...</div>

    <header class="report-header">
        <div class="container d-flex justify-content-between align-items-center">
            <div>
                <h2 class="fw-bold text-primary mb-0">
                    <i class="fas fa-user-md me-2"></i>ç—…æ‚£å¥åº·æ•¸æ“šæ‘˜è¦
                    <span class="badge bg-danger fs-6 align-middle live-badge ms-2" id="live-tag" style="display:none">LIVE</span>
                </h2>
                <small class="text-muted">Generated by Chronic Illness Guardian (FHIR R4)</small>
            </div>
            <div class="text-end">
                <p class="mb-0 fw-bold">æœ€å¾Œæ›´æ–°</p>
                <p class="mb-0" id="report-date">--</p>
            </div>
        </div>
    </header>

    <div class="container mb-5">
        <div id="error-alert" class="alert alert-danger d-none text-center">
            <i class="fas fa-exclamation-triangle me-2"></i> <span id="error-msg">ç„¡æ³•è®€å–æ•¸æ“š</span>
        </div>

        <div class="row mb-4" id="content-area">
            <div class="col-md-4 mb-3">
                <div class="patient-card">
                    <h5 class="text-secondary border-bottom pb-2 mb-3">åŸºæœ¬è³‡æ–™</h5>
                    <div class="mb-2"><strong class="text-dark">å§“å:</strong> <span id="pt-name" class="fs-5 text-primary">--</span></div>
                    <div class="mb-2"><strong class="text-dark">ID / ç—…æ­·è™Ÿ:</strong> <span id="pt-id">--</span></div>
                    <div class="mb-2"><strong class="text-dark">æ€§åˆ¥:</strong> <span id="pt-gender">--</span></div>
                    <div class="mb-2"><strong class="text-dark">å‡ºç”Ÿå¹´ä»½:</strong> <span id="pt-birth">--</span></div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="row">
                    <div class="col-md-6">
                        <div class="metric-card border-bp">
                            <h6 class="text-muted">æœ€è¿‘æ”¶ç¸®å£“/èˆ’å¼µå£“</h6>
                            <h3 class="fw-bold mb-0" id="stat-bp">--/--</h3>
                            <small class="text-danger" id="stat-bp-date">ç„¡è³‡æ–™</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="metric-card border-bs">
                            <h6 class="text-muted">æœ€è¿‘è¡€ç³– (mg/dL)</h6>
                            <h3 class="fw-bold mb-0" id="stat-bs">--</h3>
                            <small class="text-warning text-dark" id="stat-bs-date">ç„¡è³‡æ–™</small>
                        </div>
                    </div>
                </div>
                <div class="alert alert-info mt-2">
                    <i class="fas fa-robot me-2"></i><strong>ç³»çµ±æ‘˜è¦ï¼š</strong> <span id="ai-conclusion">ç­‰å¾…æ•¸æ“šåŒæ­¥...</span>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6 mb-3">
                <div class="chart-container">
                    <canvas id="bpChart"></canvas>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="chart-container">
                    <canvas id="bsChart"></canvas>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-list me-2"></i>è©³ç´°ç›£æ¸¬ç´€éŒ„ (FHIR Observation)</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover mb-0 text-center align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>æ—¥æœŸæ™‚é–“</th>
                                        <th>é¡å‹</th>
                                        <th>æ•¸å€¼</th>
                                        <th>å‚™è¨»/æœè—¥</th>
                                    </tr>
                                </thead>
                                <tbody id="records-table-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 1. MQTT è¨­å®š (ä½¿ç”¨ HiveMQ å…¬å…± Broker)
        const MQTT_BROKER = "broker.hivemq.com";
        const MQTT_PORT = 8000;
        let mqttClient = null;
        let syncTopic = "";
        let bpChart = null;
        let bsChart = null;

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(isoStr) {
            if (!isoStr) return '--';
            const d = new Date(isoStr);
            return `${d.getFullYear()}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
        }

        // è§£æ URL åƒæ•¸
        const params = new URLSearchParams(window.location.search);
        // å…©ç¨®æ¨¡å¼ï¼š 'topic' (å³æ™‚åŒæ­¥) æˆ– 'data' (éœæ…‹å¿«ç…§)
        const topicId = params.get('topic');
        const staticData = params.get('data');

        document.addEventListener('DOMContentLoaded', () => {
            if (topicId) {
                // å³æ™‚åŒæ­¥æ¨¡å¼
                initMQTT(topicId);
                document.getElementById('live-tag').style.display = 'inline-block';
            } else if (staticData) {
                // éœæ…‹æ¨¡å¼ (èˆŠç‰ˆç›¸å®¹)
                try {
                    const bundle = JSON.parse(decodeURIComponent(escape(window.atob(staticData))));
                    renderDashboard(bundle);
                    document.getElementById('status-indicator').className = 'badge bg-secondary';
                    document.getElementById('status-indicator').textContent = 'éœæ…‹å¿«ç…§æ¨¡å¼';
                } catch(e) {
                    showError("è³‡æ–™è§£æå¤±æ•—");
                }
            } else {
                showError("æœªæä¾›è³‡æ–™ä¾†æºï¼Œè«‹é‡æ–°æƒæ QR Code");
            }
        });

        function showError(msg) {
            document.getElementById('error-alert').classList.remove('d-none');
            document.getElementById('error-msg').textContent = msg;
            document.getElementById('status-indicator').className = 'badge bg-danger';
            document.getElementById('status-indicator').textContent = 'éŒ¯èª¤';
        }

        // åœ¨ doctor_view.html çš„ <script> å…§

function initMQTT(id) {
    const clientId = "doctor_" + Math.random().toString(16).substr(2, 8);
    // å¿…é ˆèˆ‡ index.html è£¡çš„ topic è¦å‰‡ä¸€è‡´
    syncTopic = `cig_health_sync/${id}`; 
    
    console.log("æº–å‚™é€£ç·šåˆ° MQTT Topic:", syncTopic);
    document.getElementById('status-indicator').textContent = 'é€£ç·š MQTT Broker ä¸­...';

    mqttClient = new Paho.MQTT.Client(MQTT_BROKER, MQTT_PORT, clientId);
    
    mqttClient.onConnectionLost = (responseObject) => {
        console.warn("é€£ç·šä¸­æ–·:", responseObject.errorMessage);
        document.getElementById('status-indicator').className = 'badge bg-danger';
        document.getElementById('status-indicator').textContent = 'é€£ç·šä¸­æ–·';
    };

    mqttClient.onMessageArrived = (message) => {
        console.log("ğŸ“© æ”¶åˆ°æ•¸æ“š!");
        document.getElementById('status-indicator').className = 'badge bg-success';
        document.getElementById('status-indicator').textContent = 'å·²åŒæ­¥æ•¸æ“š';
        
        try {
            const bundle = JSON.parse(message.payloadString);
            renderDashboard(bundle);
            
            // è¦–è¦ºå›é¥‹
            const badge = document.getElementById('live-tag');
            badge.style.display = 'inline-block';
            badge.classList.remove('live-badge'); // é‡ç½®å‹•ç•«
            void badge.offsetWidth; // Trigger reflow
            badge.classList.add('live-badge');
            
        } catch (e) {
            console.error("JSON è§£æéŒ¯èª¤", e);
            alert("æ•¸æ“šæ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç—…æ‚£ç«¯æ˜¯å¦ç™¼é€äº†æ­£ç¢ºçš„ FHIR æ ¼å¼");
        }
    };

    mqttClient.connect({
        onSuccess: () => {
            console.log("âœ… é†«å¸«ç«¯é€£ç·šæˆåŠŸï¼Œè¨‚é–±:", syncTopic);
            document.getElementById('status-indicator').className = 'badge bg-info text-dark';
            document.getElementById('status-indicator').textContent = 'ç­‰å¾…æ•¸æ“š...';
            mqttClient.subscribe(syncTopic);
        },
        onFailure: (ctx) => {
            console.error("âŒ é€£ç·šå¤±æ•—:", ctx.errorMessage);
            document.getElementById('status-indicator').className = 'badge bg-danger';
            document.getElementById('status-indicator').textContent = 'é€£ç·šå¤±æ•— (è«‹æª¢æŸ¥ç¶²è·¯)';
        },
        useSSL: false // å¿…é ˆèˆ‡ index.html è¨­å®šä¸€è‡´
    });
}

        function renderDashboard(bundle) {
            if (!bundle || !bundle.entry) return;

            document.getElementById('report-date').textContent = new Date().toLocaleTimeString();

            // è§£æ FHIR è³‡æ–™
            const patient = bundle.entry.find(e => e.resource.resourceType === 'Patient')?.resource;
            const observations = bundle.entry.filter(e => e.resource.resourceType === 'Observation').map(e => e.resource);
            const report = bundle.entry.find(e => e.resource.resourceType === 'DiagnosticReport')?.resource;

            // å¡«å¯«ç—…æ‚£è³‡æ–™
            if (patient) {
                document.getElementById('pt-name').textContent = patient.name?.[0]?.text || 'æœªçŸ¥';
                document.getElementById('pt-id').textContent = patient.identifier?.[0]?.value || 'æœªçŸ¥';
                document.getElementById('pt-gender').textContent = patient.gender === 'male' ? 'ç”·æ€§' : (patient.gender === 'female' ? 'å¥³æ€§' : 'å…¶ä»–');
                document.getElementById('pt-birth').textContent = patient.birthDate ? patient.birthDate.substring(0,4) : '--';
            }

            if (report && report.conclusion) {
                document.getElementById('ai-conclusion').textContent = report.conclusion;
            }

            // è™•ç†æ•¸æ“š
            const bpData = [];
            const bsData = [];
            const tableBody = document.getElementById('records-table-body');
            tableBody.innerHTML = ''; // æ¸…ç©ºèˆŠè³‡æ–™
            
            // æ’åº (æ–°åˆ°èˆŠ)
            observations.sort((a, b) => new Date(b.effectiveDateTime) - new Date(a.effectiveDateTime));

            observations.forEach(obs => {
                const date = obs.effectiveDateTime;
                let typeStr = "";
                let valStr = "";

                // åˆ¤æ–·æ˜¯å¦ç‚ºè¡€å£“
                const sysComp = obs.component?.find(c => c.code.coding[0].code === '8480-6');
                const diaComp = obs.component?.find(c => c.code.coding[0].code === '8462-4');
                
                if (sysComp && diaComp) {
                    const sys = sysComp.valueQuantity.value;
                    const dia = diaComp.valueQuantity.value;
                    typeStr = '<span class="badge bg-danger">è¡€å£“</span>';
                    valStr = `${sys}/${dia} mmHg`;
                    bpData.push({ x: date, s: sys, d: dia }); 
                } else if (obs.valueQuantity) {
                    const val = obs.valueQuantity.value;
                    typeStr = '<span class="badge bg-warning text-dark">è¡€ç³–</span>';
                    valStr = `${val} mg/dL`;
                    bsData.push({ x: date, v: val });
                }

                let notes = "";
                if (obs.note) notes = obs.note.map(n => n.text).join(', ');

                const row = `<tr>
                    <td>${formatDate(date)}</td>
                    <td>${typeStr}</td>
                    <td class="fw-bold">${valStr}</td>
                    <td class="text-muted small">${notes}</td>
                </tr>`;
                tableBody.insertAdjacentHTML('beforeend', row);
            });

            // æ›´æ–°æ‘˜è¦
            if (bpData.length > 0) {
                document.getElementById('stat-bp').textContent = `${bpData[0].s}/${bpData[0].d}`;
                document.getElementById('stat-bp-date').textContent = formatDate(bpData[0].x);
            }
            if (bsData.length > 0) {
                document.getElementById('stat-bs').textContent = bsData[0].v;
                document.getElementById('stat-bs-date').textContent = formatDate(bsData[0].x);
            }

            renderCharts(bpData.reverse(), bsData.reverse());
        }

        function renderCharts(bpData, bsData) {
            // éŠ·æ¯€èˆŠåœ–è¡¨ä»¥é‡ç¹ª
            if (bpChart) bpChart.destroy();
            if (bsChart) bsChart.destroy();

            bpChart = new Chart(document.getElementById('bpChart'), {
                type: 'line',
                data: {
                    labels: bpData.map(d => formatDate(d.x)),
                    datasets: [
                        { label: 'æ”¶ç¸®å£“', data: bpData.map(d => d.s), borderColor: '#dc3545', tension: 0.3 },
                        { label: 'èˆ’å¼µå£“', data: bpData.map(d => d.d), borderColor: '#0d6efd', tension: 0.3 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'è¡€å£“è¶¨å‹¢' } } }
            });

            bsChart = new Chart(document.getElementById('bsChart'), {
                type: 'line',
                data: {
                    labels: bsData.map(d => formatDate(d.x)),
                    datasets: [
                        { label: 'è¡€ç³–', data: bsData.map(d => d.v), borderColor: '#ffc107', backgroundColor: 'rgba(255, 193, 7, 0.2)', fill: true, tension: 0.3 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'è¡€ç³–è¶¨å‹¢' } } }
            });
        }
    </script>
</body>
</html>
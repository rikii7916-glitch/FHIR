<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>醫師檢視報告 (即時同步版) - Chronic Illness Guardian</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .report-header { background: white; border-bottom: 3px solid #0d6efd; padding: 20px 0; margin-bottom: 30px; }
        .patient-card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); height: 100%; }
        .metric-card { background: white; border-radius: 10px; padding: 15px; border-left: 5px solid; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .border-bp { border-left-color: #dc3545; }
        .border-bs { border-left-color: #ffc107; }
        .border-med { border-left-color: #198754; }
        .chart-container { height: 300px; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .print-btn { position: fixed; bottom: 20px; right: 20px; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .live-badge { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        #status-indicator { position: fixed; top: 10px; right: 10px; z-index: 1050; }
        .medication-badge { background-color: #198754; color: white; }
        .observation-badge { background-color: #0d6efd; color: white; }
        .table-responsive { max-height: 400px; overflow-y: auto; }
        .card-header { font-weight: 600; }
    </style>
</head>
<body>

    <div id="status-indicator" class="badge bg-secondary">連線中...</div>

    <header class="report-header">
        <div class="container d-flex justify-content-between align-items-center">
            <div>
                <h2 class="fw-bold text-primary mb-0">
                    <i class="fas fa-user-md me-2"></i>病患健康數據摘要
                    <span class="badge bg-danger fs-6 align-middle live-badge ms-2" id="live-tag" style="display:none">LIVE</span>
                </h2>
                <small class="text-muted">Generated by Chronic Illness Guardian (FHIR R4)</small>
            </div>
            <div class="text-end">
                <p class="mb-0 fw-bold">最後更新</p>
                <p class="mb-0" id="report-date">--</p>
            </div>
        </div>
    </header>

    <div class="container mb-5">
        <div id="error-alert" class="alert alert-danger d-none text-center">
            <i class="fas fa-exclamation-triangle me-2"></i> <span id="error-msg">無法讀取數據</span>
        </div>

        <div class="row mb-4" id="content-area">
            <div class="col-md-4 mb-3">
                <div class="patient-card">
                    <h5 class="text-secondary border-bottom pb-2 mb-3">基本資料</h5>
                    <div class="mb-2"><strong class="text-dark">姓名:</strong> <span id="pt-name" class="fs-5 text-primary">--</span></div>
                    <div class="mb-2"><strong class="text-dark">ID / 病歷號:</strong> <span id="pt-id">--</span></div>
                    <div class="mb-2"><strong class="text-dark">性別:</strong> <span id="pt-gender">--</span></div>
                    <div class="mb-2"><strong class="text-dark">出生年份:</strong> <span id="pt-birth">--</span></div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="row">
                    <div class="col-md-4">
                        <div class="metric-card border-bp">
                            <h6 class="text-muted">最近收縮壓/舒張壓</h6>
                            <h3 class="fw-bold mb-0" id="stat-bp">--/--</h3>
                            <small class="text-danger" id="stat-bp-date">無資料</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="metric-card border-bs">
                            <h6 class="text-muted">最近血糖 (mg/dL)</h6>
                            <h3 class="fw-bold mb-0" id="stat-bs">--</h3>
                            <small class="text-warning text-dark" id="stat-bs-date">無資料</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="metric-card border-med">
                            <h6 class="text-muted">最近藥物紀錄</h6>
                            <h3 class="fw-bold mb-0" id="stat-med-count">--</h3>
                            <small class="text-success" id="stat-med-date">無資料</small>
                        </div>
                    </div>
                </div>
                <div class="alert alert-info mt-2">
                    <i class="fas fa-robot me-2"></i><strong>系統摘要：</strong> <span id="ai-conclusion">等待數據同步...</span>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6 mb-3">
                <div class="chart-container">
                    <canvas id="bpChart"></canvas>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="chart-container">
                    <canvas id="bsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 兩欄顯示：藥物紀錄和詳細監測紀錄 -->
        <div class="row">
            <!-- 左欄：藥物紀錄 -->
            <div class="col-md-6 mb-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-pills me-2"></i>藥物紀錄</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover mb-0 text-center align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>日期時間</th>
                                        <th>藥物名稱</th>
                                        <th>類別</th>
                                        <th>備註</th>
                                    </tr>
                                </thead>
                                <tbody id="medication-table-body">
                                    <tr>
                                        <td colspan="4" class="text-center text-muted py-4">
                                            <i class="fas fa-pills fa-2x mb-2"></i>
                                            <p>暫無藥物紀錄</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右欄：詳細監測紀錄 -->
            <div class="col-md-6 mb-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-list me-2"></i>詳細監測紀錄 (FHIR Observation)</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover mb-0 text-center align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>日期時間</th>
                                        <th>類型</th>
                                        <th>數值</th>
                                        <th>備註/服藥</th>
                                    </tr>
                                </thead>
                                <tbody id="records-table-body">
                                    <tr>
                                        <td colspan="4" class="text-center text-muted py-4">
                                            <i class="fas fa-heartbeat fa-2x mb-2"></i>
                                            <p>等待數據同步...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // MQTT 設定 (使用 HiveMQ 公共 Broker)
        const MQTT_BROKER = "broker.hivemq.com";
        const MQTT_PORT = 8000;
        let mqttClient = null;
        let syncTopic = "";
        let bpChart = null;
        let bsChart = null;

        // 格式化日期
        function formatDate(isoStr) {
            if (!isoStr) return '--';
            const d = new Date(isoStr);
            return `${d.getFullYear()}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
        }

        // 解析 URL 參數
        const params = new URLSearchParams(window.location.search);
        const topicId = params.get('topic');
        const staticData = params.get('data');

        document.addEventListener('DOMContentLoaded', () => {
            if (topicId) {
                initMQTT(topicId);
                document.getElementById('live-tag').style.display = 'inline-block';
            } else if (staticData) {
                try {
                    const bundle = JSON.parse(decodeURIComponent(escape(window.atob(staticData))));
                    renderDashboard(bundle);
                    document.getElementById('status-indicator').className = 'badge bg-secondary';
                    document.getElementById('status-indicator').textContent = '靜態快照模式';
                } catch(e) {
                    showError("資料解析失敗");
                }
            } else {
                showError("未提供資料來源，請重新掃描 QR Code");
            }
        });

        function showError(msg) {
            document.getElementById('error-alert').classList.remove('d-none');
            document.getElementById('error-msg').textContent = msg;
            document.getElementById('status-indicator').className = 'badge bg-danger';
            document.getElementById('status-indicator').textContent = '錯誤';
        }

        function initMQTT(id) {
            const clientId = "doctor_" + Math.random().toString(16).substr(2, 8);
            syncTopic = `cig_health_sync/${id}`; 
            
            console.log("準備連線到 MQTT Topic:", syncTopic);
            document.getElementById('status-indicator').textContent = '連線 MQTT Broker 中...';

            mqttClient = new Paho.MQTT.Client(MQTT_BROKER, MQTT_PORT, clientId);
            
            mqttClient.onConnectionLost = (responseObject) => {
                console.warn("連線中斷:", responseObject.errorMessage);
                document.getElementById('status-indicator').className = 'badge bg-danger';
                document.getElementById('status-indicator').textContent = '連線中斷';
            };

            mqttClient.onMessageArrived = (message) => {
                console.log("收到數據!");
                document.getElementById('status-indicator').className = 'badge bg-success';
                document.getElementById('status-indicator').textContent = '已同步數據';
                
                try {
                    const bundle = JSON.parse(message.payloadString);
                    renderDashboard(bundle);
                    
                    const badge = document.getElementById('live-tag');
                    badge.style.display = 'inline-block';
                    badge.classList.remove('live-badge');
                    void badge.offsetWidth;
                    badge.classList.add('live-badge');
                    
                } catch (e) {
                    console.error("JSON 解析錯誤", e);
                    alert("數據格式錯誤，請檢查病患端是否發送了正確的 FHIR 格式");
                }
            };

            mqttClient.connect({
                onSuccess: () => {
                    console.log("醫師端連線成功，訂閱:", syncTopic);
                    document.getElementById('status-indicator').className = 'badge bg-info text-dark';
                    document.getElementById('status-indicator').textContent = '等待數據...';
                    mqttClient.subscribe(syncTopic);
                },
                onFailure: (ctx) => {
                    console.error("連線失敗:", ctx.errorMessage);
                    document.getElementById('status-indicator').className = 'badge bg-danger';
                    document.getElementById('status-indicator').textContent = '連線失敗 (請檢查網路)';
                },
                useSSL: false
            });
        }

        function renderDashboard(bundle) {
            if (!bundle || !bundle.entry) return;

            document.getElementById('report-date').textContent = new Date().toLocaleTimeString();

            // 解析 FHIR 資料
            const patient = bundle.entry.find(e => e.resource.resourceType === 'Patient')?.resource;
            const observations = bundle.entry.filter(e => e.resource.resourceType === 'Observation').map(e => e.resource);
            const medications = bundle.entry.filter(e => 
                e.resource.resourceType === 'MedicationStatement' || 
                e.resource.resourceType === 'MedicationRequest' ||
                e.resource.resourceType === 'MedicationAdministration' ||
                e.resource.resourceType === 'MedicationDispense' ||
                e.resource.resourceType === 'Medication'  // 添加 Medication 类型
            ).map(e => e.resource);
            const report = bundle.entry.find(e => e.resource.resourceType === 'DiagnosticReport')?.resource;

            // 填寫病患資料
            if (patient) {
                document.getElementById('pt-name').textContent = patient.name?.[0]?.text || '未知';
                document.getElementById('pt-id').textContent = patient.identifier?.[0]?.value || '未知';
                document.getElementById('pt-gender').textContent = patient.gender === 'male' ? '男性' : (patient.gender === 'female' ? '女性' : '其他');
                document.getElementById('pt-birth').textContent = patient.birthDate ? patient.birthDate.substring(0,4) : '--';
            }

            if (report && report.conclusion) {
                document.getElementById('ai-conclusion').textContent = report.conclusion;
            }

            // 處理監測數據
            const bpData = [];
            const bsData = [];
            const recordsTableBody = document.getElementById('records-table-body');
            recordsTableBody.innerHTML = '';
            
            observations.sort((a, b) => new Date(b.effectiveDateTime) - new Date(a.effectiveDateTime));

            observations.forEach(obs => {
                const date = obs.effectiveDateTime;
                let typeStr = "";
                let valStr = "";

                // 判斷是否為血壓
                const sysComp = obs.component?.find(c => c.code.coding[0].code === '8480-6');
                const diaComp = obs.component?.find(c => c.code.coding[0].code === '8462-4');
                
                if (sysComp && diaComp) {
                    const sys = sysComp.valueQuantity.value;
                    const dia = diaComp.valueQuantity.value;
                    typeStr = '<span class="badge bg-danger">血壓</span>';
                    valStr = `${sys}/${dia} mmHg`;
                    bpData.push({ x: date, s: sys, d: dia }); 
                } else if (obs.valueQuantity) {
                    const val = obs.valueQuantity.value;
                    typeStr = '<span class="badge bg-warning text-dark">血糖</span>';
                    valStr = `${val} mg/dL`;
                    bsData.push({ x: date, v: val });
                }

                let notes = "";
                if (obs.note) notes = obs.note.map(n => n.text).join(', ');

                const row = `<tr>
                    <td>${formatDate(date)}</td>
                    <td>${typeStr}</td>
                    <td class="fw-bold">${valStr}</td>
                    <td class="text-muted small">${notes}</td>
                </tr>`;
                recordsTableBody.insertAdjacentHTML('beforeend', row);
            });

            // 處理藥物紀錄
            const medTableBody = document.getElementById('medication-table-body');
            medTableBody.innerHTML = '';
            
            if (medications.length > 0) {
                medications.sort((a, b) => {
                    const dateA = a.authoredOn || a.dateAsserted || a.effectiveDateTime || '1970-01-01';
                    const dateB = b.authoredOn || b.dateAsserted || b.effectiveDateTime || '1970-01-01';
                    return new Date(dateB) - new Date(dateA);
                });
                
                medications.forEach(med => {
                    let medName = '未知藥物';
                    if (med.medicationCodeableConcept && med.medicationCodeableConcept.text) {
                        medName = med.medicationCodeableConcept.text;
                    } else if (med.medicationReference && med.medicationReference.display) {
                        medName = med.medicationReference.display;
                    } else if (med.medicationCodeableConcept && med.medicationCodeableConcept.coding) {
                        medName = med.medicationCodeableConcept.coding[0]?.display || med.medicationCodeableConcept.coding[0]?.code || '未知藥物';
                    }
                    
                    const date = med.authoredOn || med.dateAsserted || med.effectiveDateTime || '--';
                    
                    let category = '一般用藥';
                    if (med.category && med.category.coding && med.category.coding.length > 0) {
                        category = med.category.coding[0].display || med.category.coding[0].code || '一般用藥';
                    }
                    
                    let notes = '無備註';
                    if (med.note && Array.isArray(med.note)) {
                        notes = med.note.map(n => n.text).filter(text => text).join(', ') || '無備註';
                    }

                    const row = `<tr>
                        <td>${formatDate(date)}</td>
                        <td class="fw-bold">${medName}</td>
                        <td><span class="badge bg-success">${category}</span></td>
                        <td class="text-muted small">${notes}</td>
                    </tr>`;
                    medTableBody.insertAdjacentHTML('beforeend', row);
                });
                
                document.getElementById('stat-med-count').textContent = medications.length;
                const latestMed = medications[0];
                const latestDate = latestMed.authoredOn || latestMed.dateAsserted || latestMed.effectiveDateTime;
                document.getElementById('stat-med-date').textContent = formatDate(latestDate);
            } else {
                medTableBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-muted py-4">
                            <i class="fas fa-pills fa-2x mb-2"></i>
                            <p>暫無藥物紀錄</p>
                        </td>
                    </tr>
                `;
                document.getElementById('stat-med-count').textContent = '0';
                document.getElementById('stat-med-date').textContent = '無資料';
            }

            // 更新摘要
            if (bpData.length > 0) {
                document.getElementById('stat-bp').textContent = `${bpData[0].s}/${bpData[0].d}`;
                document.getElementById('stat-bp-date').textContent = formatDate(bpData[0].x);
            } else {
                document.getElementById('stat-bp').textContent = '--/--';
                document.getElementById('stat-bp-date').textContent = '無資料';
            }
            
            if (bsData.length > 0) {
                document.getElementById('stat-bs').textContent = bsData[0].v;
                document.getElementById('stat-bs-date').textContent = formatDate(bsData[0].x);
            } else {
                document.getElementById('stat-bs').textContent = '--';
                document.getElementById('stat-bs-date').textContent = '無資料';
            }

            renderCharts(bpData.reverse(), bsData.reverse());
        }

        function renderCharts(bpData, bsData) {
            if (bpChart) bpChart.destroy();
            if (bsChart) bsChart.destroy();

            // 血壓圖表
            if (bpData.length > 0) {
                bpChart = new Chart(document.getElementById('bpChart'), {
                    type: 'line',
                    data: {
                        labels: bpData.map(d => formatDate(d.x)),
                        datasets: [
                            { label: '收縮壓', data: bpData.map(d => d.s), borderColor: '#dc3545', tension: 0.3 },
                            { label: '舒張壓', data: bpData.map(d => d.d), borderColor: '#0d6efd', tension: 0.3 }
                        ]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { title: { display: true, text: '血壓趨勢' } },
                        scales: {
                            y: {
                                title: { display: true, text: '血壓 (mmHg)' }
                            }
                        }
                    }
                });
            } else {
                document.getElementById('bpChart').innerHTML = '<p class="text-muted text-center py-5">暫無血壓數據</p>';
            }

            // 血糖圖表
            if (bsData.length > 0) {
                bsChart = new Chart(document.getElementById('bsChart'), {
                    type: 'line',
                    data: {
                        labels: bsData.map(d => formatDate(d.x)),
                        datasets: [
                            { label: '血糖', data: bsData.map(d => d.v), borderColor: '#ffc107', backgroundColor: 'rgba(255, 193, 7, 0.2)', fill: true, tension: 0.3 }
                        ]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { title: { display: true, text: '血糖趨勢' } },
                        scales: {
                            y: {
                                title: { display: true, text: '血糖 (mg/dL)' }
                            }
                        }
                    }
                });
            } else {
                document.getElementById('bsChart').innerHTML = '<p class="text-muted text-center py-5">暫無血糖數據</p>';
            }
        }
    </script>
</body>
</html>
